#!/bin/bash
#
# PR News - GitHub PR Learning Tool
# ==================================
#
# GitHub ë ˆí¬ì§€í† ë¦¬ì˜ ìµœê·¼ ë¨¸ì§€ëœ PRë“¤ì„ ë¶„ì„í•˜ì—¬
# ì»¨íŠ¸ë¦¬ë·°í„°ê°€ ë”°ë¼ì¡ì•„ì•¼ í•  ë‚´ìš©ì„ LLM ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½í•©ë‹ˆë‹¤.
#
# Usage:
#   ./pr-news              # ëŒ€í™”í˜• ì‹¤í–‰
#   DAYS=14 ./pr-news      # í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì • ì˜¤ë²„ë¼ì´ë“œ
#
# Configuration:
#   ~/.pr-news.conf        # ì„¤ì • íŒŒì¼ (ì„ íƒ)
#
# Requirements:
#   - gh (GitHub CLI, authenticated)
#   - claude (Claude CLI)
#   - jq (JSON processing)
#   - gum (optional, for better TUI)
#   - fzf (optional, for fuzzy selection)
#
# Author: Generated with Claude Code
#

set -euo pipefail

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load modules
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/ui.sh"
source "$SCRIPT_DIR/lib/github.sh"
source "$SCRIPT_DIR/lib/llm.sh"

# Main function
main() {
  # Load configuration
  config::load

  # Check dependencies
  if ! config::check_deps; then
    exit 1
  fi

  # Show header
  ui::header

  # Step 1: Repository Selection
  ui::section "Repository Selection"

  # Fetch repos with spinner
  local repos
  if [[ $HAS_GUM -eq 1 ]]; then
    repos=$(gum spin --spinner dot --title "Loading repositories..." -- bash -c "
      source '$SCRIPT_DIR/lib/github.sh'
      gh::list_repos 30
    ")
  else
    echo -en "${C_DIM}â–¸${C_RESET} Loading repositories... "
    repos=$(gh::list_repos 30)
    echo -e "${C_GREEN}âœ“${C_RESET}"
  fi

  if [[ -z "$repos" ]]; then
    ui::error "No repositories found"
    exit 1
  fi

  local repo
  repo=$(echo "$repos" | ui::choose "ğŸ“¦ Select repository (type to search, j/k to navigate)")

  if [[ -z "$repo" ]]; then
    ui::error "No repository selected"
    exit 1
  fi

  ui::success "Selected: $repo"

  # Step 2: Configure Options
  ui::section "Options"

  # Get days input
  local days_input
  days_input=$(ui::input "ğŸ“… ì¡°íšŒ ê¸°ê°„ (ì¼)" "$DAYS" "ìˆ«ì ì…ë ¥")
  DAYS="${days_input:-$DAYS}"
  ui::success "ê¸°ê°„: ${DAYS}ì¼"

  # Get base branch (optional)
  local base_branch=""
  local branches
  ui::status "ë¸Œëœì¹˜ ëª©ë¡ ì¡°íšŒì¤‘..."
  branches=$(gh::list_branches "$repo" 20)
  ui::clear_line

  if [[ -n "$branches" ]]; then
    # Add "all branches" option at the top
    local branch_options="(ì „ì²´ ë¸Œëœì¹˜)"$'\n'"$branches"
    local selected_branch
    selected_branch=$(echo "$branch_options" | ui::choose "ğŸŒ¿ ëŒ€ìƒ ë¸Œëœì¹˜ ì„ íƒ (Enter: ì „ì²´)")

    if [[ -n "$selected_branch" && "$selected_branch" != "(ì „ì²´ ë¸Œëœì¹˜)" ]]; then
      base_branch="$selected_branch"
      ui::success "ë¸Œëœì¹˜: $base_branch"
    else
      ui::success "ë¸Œëœì¹˜: ì „ì²´"
    fi
  fi

  # Step 3: Fetch PRs
  ui::section "Fetching PRs (last $DAYS days)"

  local prs_json
  if [[ $HAS_GUM -eq 1 ]]; then
    prs_json=$(gum spin --spinner dot --title "Fetching merged PRs from $repo..." -- bash -c "
      source '$SCRIPT_DIR/lib/config.sh'
      source '$SCRIPT_DIR/lib/github.sh'
      config::load
      gh::list_merged_prs '$repo' '$DAYS' '$base_branch'
    ")
  else
    ui::status "Fetching merged PRs..."
    prs_json=$(gh::list_merged_prs "$repo" "$DAYS" "$base_branch")
    ui::status_done "Fetched merged PRs"
  fi

  local pr_count
  pr_count=$(echo "$prs_json" | jq 'length')

  if [[ "$pr_count" -eq 0 ]]; then
    ui::info "No merged PRs found in the last $DAYS days"
    exit 0
  fi

  ui::success "Found $pr_count merged PRs"

  # Step 4: Collect PR data
  ui::section "Analyzing PRs"

  local all_pr_data=""
  local current=0

  while IFS= read -r pr; do
    current=$((current + 1))
    local number=$(echo "$pr" | jq -r '.number')
    local title=$(echo "$pr" | jq -r '.title')

    # In-place progress update (same line)
    ui::status "[$current/$pr_count] PR #$number: ${title:0:40}..."

    local pr_data
    pr_data=$(gh::collect_pr_data "$repo" "$pr")
    all_pr_data+="$pr_data"
    all_pr_data+="\n---\n"
  done < <(echo "$prs_json" | jq -c '.[]')

  # Clear progress line and show completion
  ui::status_done "Collected data from $pr_count PRs"

  # Step 5: Generate Summary with LLM
  ui::section "Generating Summary"

  # Build prompt for Claude
  local prompt="ë‹¤ìŒì€ ${repo} ë ˆí¬ì§€í† ë¦¬ì˜ ìµœê·¼ ë¨¸ì§€ëœ PR ${pr_count}ê°œì…ë‹ˆë‹¤.
ì»¨íŠ¸ë¦¬ë·°í„°ë¡œì„œ ë”°ë¼ì¡ì•„ì•¼ í•  í•µì‹¬ ë‚´ìš©ì„ ìš”ì•½í•´ì£¼ì„¸ìš”.

---
$(echo -e "$all_pr_data")
---

ìœ„ PRë“¤ì„ ë¶„ì„í•˜ì—¬ ë‹¤ìŒ ì„¹ì…˜ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:

## ğŸ“¦ ì£¼ìš” ë³€ê²½ì‚¬í•­
(ìƒˆ ê¸°ëŠ¥, ê°œì„ , ë¦¬íŒ©í† ë§ ë“±)

## ğŸ› ë²„ê·¸ ìˆ˜ì •
(ìˆëŠ” ê²½ìš°ë§Œ)

## ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸
(ë¦¬ë·° ì½”ë©˜íŠ¸ì—ì„œ ì–»ì€ ì¸ì‚¬ì´íŠ¸, ì½”ë“œ íŒ¨í„´ ë“±)

## âš ï¸ ì£¼ì˜ì‚¬í•­
(breaking changes, ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš” ë“± - ìˆëŠ” ê²½ìš°ë§Œ)"

  # Write prompt to temp file for Claude
  local tmp_file=$(mktemp)
  echo "$prompt" > "$tmp_file"

  local summary
  if [[ $HAS_GUM -eq 1 ]]; then
    summary=$(gum spin --spinner dot --title "Claude is analyzing..." -- \
      bash -c "cat '$tmp_file' | claude -p 2>/dev/null")
  else
    echo -en "${C_DIM}â–¸${C_RESET} Claude is analyzing... "
    summary=$(cat "$tmp_file" | claude -p 2>/dev/null)
    echo -e "${C_GREEN}âœ“${C_RESET}"
  fi

  rm -f "$tmp_file"

  # Step 6: Display Summary
  ui::section "PR News Summary for $repo"

  echo ""
  echo "$summary"
  echo ""

  ui::info "Analyzed $pr_count PRs from last $DAYS days"
}

# Run main
main "$@"
